#!/bin/bash
# Wrapper script for MCP server that sets up asdf environment

# Source asdf if available
if [ -f "$HOME/.asdf/asdf.sh" ]; then
  . "$HOME/.asdf/asdf.sh"
fi

# Change to the mimo-mcp directory
cd /workspace/mrc-server/mimo-mcp

# Set environment
export MIX_ENV=dev
export ELIXIR_ERL_OPTIONS="+fnu"

# Use unique ports based on PID to avoid conflicts between sessions
export MIMO_HTTP_PORT=$((50000 + ($$  % 10000)))
export MCP_PORT=$((40000 + ($$ % 10000)))

# Disable Prometheus metrics entirely (causes port conflicts)
export PROMETHEUS_DISABLED=true

# Disable HTTP server startup for stdio mode
export MIMO_DISABLE_HTTP=true

# Suppress logs for clean stdio (only errors go to stderr)
export LOGGER_LEVEL=error

# Run the MCP server in stdio mode
exec mix run --no-halt --no-compile -e "Mimo.McpServer.Stdio.start()"
