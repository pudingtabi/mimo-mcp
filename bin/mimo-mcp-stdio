#!/bin/bash
# Mimo MCP Server - Direct stdio launcher for VS Code
# This script is called by VS Code's MCP client

set -e

# Determine Mimo directory:
# 1. Use MIMO_ROOT if set by VS Code's mcp.json
# 2. Otherwise, determine from script location
if [ -n "$MIMO_ROOT" ]; then
  MIMO_DIR="$MIMO_ROOT"
else
  # Get the directory where this script lives, then go up one level
  SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
  MIMO_DIR="$(dirname "$SCRIPT_DIR")"
fi

cd "$MIMO_DIR"

# Load environment if present
if [ -f .env ]; then
  export $(grep -v '^#' .env | xargs 2>/dev/null) || true
fi

# ============================================================================
# Elixir/Erlang PATH Setup
# VS Code environment may not have asdf or proper PATH, so we set it explicitly
# ============================================================================
if [ -f "$MIMO_DIR/.tool-versions" ]; then
  ELIXIR_VERSION=$(grep elixir "$MIMO_DIR/.tool-versions" | awk '{print $2}')
  ERLANG_VERSION=$(grep erlang "$MIMO_DIR/.tool-versions" | awk '{print $2}')
  
  if [ -n "$ELIXIR_VERSION" ] && [ -n "$ERLANG_VERSION" ]; then
    ELIXIR_INSTALL_DIR="${HOME}/.elixir-install/installs"
    ELIXIR_BIN="${ELIXIR_INSTALL_DIR}/elixir/${ELIXIR_VERSION}/bin"
    ERLANG_BIN="${ELIXIR_INSTALL_DIR}/otp/${ERLANG_VERSION}/bin"
    ERTS_BIN="${ELIXIR_INSTALL_DIR}/otp/${ERLANG_VERSION}/erts-*/bin"
    
    # Add to PATH if directories exist
    [ -d "$ELIXIR_BIN" ] && export PATH="$ELIXIR_BIN:$PATH"
    [ -d "$ERLANG_BIN" ] && export PATH="$ERLANG_BIN:$PATH"
    for erts in $ERTS_BIN; do
      [ -d "$erts" ] && export PATH="$erts:$PATH"
    done
  fi
fi


# ============================================================================
# Ollama Dependency Check
# Mimo requires Ollama for local embeddings (memory search, semantic features)
# OpenRouter is used for LLM chat - they are separate services
# ============================================================================
OLLAMA_URL="${OLLAMA_URL:-http://localhost:11434}"

check_ollama() {
  # Try to connect to Ollama
  if curl -s --connect-timeout 2 "${OLLAMA_URL}/api/tags" >/dev/null 2>&1; then
    return 0
  fi
  return 1
}

start_ollama() {
  # Check if ollama command exists
  if ! command -v ollama >/dev/null 2>&1; then
    echo '{"jsonrpc":"2.0","id":1,"error":{"code":-32000,"message":"Ollama not installed. Please install from https://ollama.ai"}}' >&2
    exit 1
  fi
  
  # Start ollama serve in background
  nohup ollama serve >/dev/null 2>&1 &
  
  # Wait up to 10 seconds for Ollama to start
  for i in {1..20}; do
    if check_ollama; then
      return 0
    fi
    sleep 0.5
  done
  
  return 1
}

# Check if Ollama is running, start if not
if ! check_ollama; then
  if ! start_ollama; then
    echo '{"jsonrpc":"2.0","id":1,"error":{"code":-32001,"message":"Failed to start Ollama. Memory search will not work. Start manually with: ollama serve"}}' >&2
    # Continue anyway - Mimo can run with degraded memory search
  fi
fi

# Required environment for proper operation
export MIX_ENV="${MIX_ENV:-dev}"
export ELIXIR_ERL_OPTIONS="+fnu"
export LOGGER_LEVEL=none
export MIMO_DISABLE_HTTP=true
export MIX_QUIET=1

# IMPORTANT: MCP stdio requires stdout to be JSON-RPC only.
# If Mix compiles during startup it prints lines like "==> exqlite" to stdout,
# which VS Code then fails to parse as JSON.
APP_FILE="$MIMO_DIR/_build/${MIX_ENV}/lib/mimo_mcp/ebin/mimo_mcp.app"
if [ ! -f "$APP_FILE" ]; then
  # Redirect all build output to stderr so stdout stays protocol-clean.
  mix deps.get 1>&2
  mix compile 1>&2
fi

# Run the MCP server in stdio mode
exec mix run --no-halt --no-compile -e "Mimo.McpServer.Stdio.start()"
